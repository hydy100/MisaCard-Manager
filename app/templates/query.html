<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MisaCard å¡ç‰‡æŸ¥è¯¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .copy-field {
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .copy-field:hover {
            background-color: #f3f4f6;
            transform: translateX(2px);
        }
        .copy-field:active {
            transform: scale(0.98);
        }
        
        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            transition: background 0.2s;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        ::-webkit-scrollbar-corner {
            background: #f1f5f9;
        }
        
        /* Firefox æ»šåŠ¨æ¡ */
        * {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50 min-h-screen">
    <!-- é¡¶éƒ¨æ  -->
    <nav class="bg-white shadow-md">
        <div class="max-w-6xl mx-auto px-4 lg:px-6">
            <div class="flex justify-between items-center h-12 lg:h-14">
                <div class="flex items-center">
                    <h1 class="text-lg lg:text-xl xl:text-2xl font-bold text-blue-600">MisaCard</h1>
                    <span class="ml-2 text-xs lg:text-sm text-gray-500">å¡ç‰‡æŸ¥è¯¢</span>
                </div>
                <div>
                    <a href="/login" class="inline-flex items-center px-3 py-1.5 lg:px-4 lg:py-2 text-sm lg:text-base bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                        <svg class="w-4 h-4 lg:w-5 lg:h-5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                        ç®¡ç†å‘˜ç™»å½•
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="max-w-6xl mx-auto px-4 lg:px-6 py-4 lg:py-6">
        <!-- æŸ¥è¯¢è¡¨å• -->
        <div class="bg-white rounded-lg shadow-lg p-4 lg:p-6 mb-4 lg:mb-6">
            <h2 class="text-base lg:text-lg xl:text-xl font-bold text-gray-800 mb-3 lg:mb-4">å¡å¯†æ¿€æ´»æˆ–å¡ç‰‡ä¿¡æ¯æŸ¥è¯¢</h2>
            <div class="flex flex-wrap gap-2 lg:gap-3">
                <!-- API é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆä»…å¤šä¸ª API æ—¶æ˜¾ç¤ºï¼‰ -->
                <select
                    id="apiSelect"
                    class="px-3 py-2 lg:px-4 lg:py-2.5 text-sm lg:text-base border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white flex-shrink-0"
                    style="display: none;"
                >
                    <!-- åŠ¨æ€å¡«å…… -->
                </select>
                
                <input
                    type="text"
                    id="queryInput"
                    placeholder="è¯·è¾“å…¥å¡å¯†æˆ–å¡å· (16ä½æ•°å­—)"
                    class="flex-1 min-w-0 px-3 py-2 lg:px-4 lg:py-2.5 text-sm lg:text-base border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                    onclick="queryCard()"
                    class="px-4 py-2 lg:px-8 lg:py-2.5 text-sm lg:text-base bg-blue-600 text-white rounded font-semibold hover:bg-blue-700 transition whitespace-nowrap flex-shrink-0"
                >
                    æŸ¥è¯¢
                </button>
                <button
                    onclick="queryAndActivateCard()"
                    class="px-4 py-2 lg:px-8 lg:py-2.5 text-sm lg:text-base bg-green-600 text-white rounded font-semibold hover:bg-green-700 transition whitespace-nowrap flex-shrink-0"
                >
                    æŸ¥è¯¢å¹¶æ¿€æ´»
                </button>
            </div>
            <p class="mt-2 lg:mt-3 text-xs lg:text-sm text-gray-500">
                ğŸ’¡ <strong>æŸ¥è¯¢</strong>ï¼šä»…æŸ¥è¯¢å¡ç‰‡ä¿¡æ¯ï¼Œ<span class="text-orange-600">æœªæ¿€æ´»çš„å¡å¯†ä¸ä¼šè‡ªåŠ¨æ¿€æ´»</span> | <strong>æŸ¥è¯¢å¹¶æ¿€æ´»</strong>ï¼šæŸ¥è¯¢åå¦‚æœå¡å¯†æœªæ¿€æ´»ä¼šè‡ªåŠ¨æ¿€æ´» | å¡å·ä»…æŸ¥çœ‹ä½™é¢å’Œäº¤æ˜“è®°å½•
            </p>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingState" class="hidden text-center py-8 lg:py-12">
            <svg class="animate-spin h-8 w-8 lg:h-10 lg:w-10 text-blue-600 mx-auto mb-2 lg:mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600 text-sm lg:text-base">æ­£åœ¨æŸ¥è¯¢...</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="errorMessage" class="hidden bg-red-50 border border-red-300 text-red-700 px-4 py-3 lg:px-5 lg:py-4 rounded-lg mb-4 lg:mb-6 fade-in text-sm lg:text-base">
            <div class="flex items-center">
                <svg class="w-4 h-4 lg:w-5 lg:h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <span id="errorText"></span>
            </div>
        </div>

        <!-- å¡ç‰‡åŸºæœ¬ä¿¡æ¯ï¼ˆä»…å¡å¯†æŸ¥è¯¢æ—¶æ˜¾ç¤ºï¼‰ -->
        <div id="cardBasicInfo" class="hidden bg-white rounded-lg shadow-lg p-4 lg:p-6 mb-4 lg:mb-6 fade-in">
            <div class="flex justify-between items-center mb-2 lg:mb-3">
                <h3 class="text-base lg:text-lg xl:text-xl font-bold text-gray-800">å¡ç‰‡ä¿¡æ¯</h3>
                <button onclick="copyCardInfo()" class="px-3 py-1.5 lg:px-4 lg:py-2 text-sm lg:text-base bg-green-600 text-white rounded hover:bg-green-700 transition flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5 lg:w-4 lg:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    ä¸€é”®å¤åˆ¶å…¨éƒ¨
                </button>
            </div>
            <p class="text-xs lg:text-sm text-gray-500 mb-3 lg:mb-4">ğŸ’¡ ç‚¹å‡»å„å­—æ®µå•ç‹¬å¤åˆ¶</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1.5 lg:gap-2" id="basicInfoContent">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- ä½™é¢å’Œæ¶ˆè´¹è®°å½• -->
        <div id="transactionInfo" class="hidden bg-white rounded-lg shadow-lg p-4 lg:p-6 fade-in">
            <div class="flex justify-between items-center mb-3 lg:mb-4">
                <h3 class="text-base lg:text-lg xl:text-xl font-bold text-gray-800">ä½™é¢ä¸æ¶ˆè´¹è®°å½•</h3>
                <button id="refreshBtn" onclick="refreshTransactions()" class="px-3 py-1.5 lg:px-4 lg:py-2 text-sm lg:text-base bg-blue-600 text-white rounded hover:bg-blue-700 transition flex items-center gap-1.5">
                    <svg id="refreshIcon" class="w-3.5 h-3.5 lg:w-4 lg:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span id="refreshText">åˆ·æ–°</span>
                </button>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="transactionLoading" class="hidden text-center py-6 lg:py-8">
                <svg class="animate-spin h-8 w-8 lg:h-10 lg:w-10 text-blue-600 mx-auto mb-2 lg:mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-gray-600 text-sm lg:text-base">æ­£åœ¨åŠ è½½äº¤æ˜“ä¿¡æ¯...</p>
            </div>

            <!-- ä½™é¢ä¿¡æ¯ -->
            <div id="transactionContent" class="hidden">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 lg:gap-3 mb-4 lg:mb-5" id="balanceContent">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>

                <!-- æ¶ˆè´¹è®°å½• -->
                <div>
                    <h4 class="text-sm lg:text-base font-semibold text-gray-800 mb-2 lg:mb-3">æ¶ˆè´¹è®°å½•</h4>
                    <div id="transactionsContent" class="space-y-2 lg:space-y-3">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="text-center py-12 lg:py-16">
            <svg class="mx-auto h-16 w-16 lg:h-20 lg:w-20 text-gray-400 mb-3 lg:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <h3 class="text-base lg:text-lg font-semibold text-gray-700 mb-1">è¯·è¾“å…¥å¡å¯†æˆ–å¡å·æŸ¥è¯¢</h3>
            <p class="text-sm lg:text-base text-gray-500">æ”¯æŒå¡å¯†æˆ–16ä½å¡å·</p>
        </div>
    </div>

    <script>
        // API é…ç½®ï¼ˆä»æœåŠ¡å™¨ç«¯æ³¨å…¥ï¼‰
        const API_CONFIGS = {{ api_configs | tojson }};
        const API_TOKEN = {{ api_token | tojson }};  // å‘åå…¼å®¹
        
        let currentApiConfig = null;  // å½“å‰é€‰æ‹©çš„ API é…ç½®
        let currentCardId = null;
        let currentCardNumber = null;
        let queryType = null; // 'card_id' or 'card_number'
        let currentCardData = null; // å­˜å‚¨å½“å‰å¡ç‰‡æ•°æ®
        
        // åˆå§‹åŒ– API é…ç½®
        function initApiConfigs() {
            const apiSelect = document.getElementById('apiSelect');
            
            if (API_CONFIGS && API_CONFIGS.length > 1) {
                // æœ‰å¤šä¸ª APIï¼Œæ˜¾ç¤ºä¸‹æ‹‰æ¡†
                apiSelect.style.display = 'block';
                
                // å¡«å……ä¸‹æ‹‰æ¡†é€‰é¡¹
                API_CONFIGS.forEach((config, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = config.name;
                    apiSelect.appendChild(option);
                });
                
                // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                currentApiConfig = API_CONFIGS[0];
            } else if (API_CONFIGS && API_CONFIGS.length === 1) {
                // åªæœ‰ä¸€ä¸ª APIï¼Œä¸æ˜¾ç¤ºä¸‹æ‹‰æ¡†
                apiSelect.style.display = 'none';
                currentApiConfig = API_CONFIGS[0];
            } else {
                // å‘åå…¼å®¹ï¼šä½¿ç”¨æ—§çš„ API_TOKEN
                currentApiConfig = {
                    name: "é»˜è®¤",
                    base_url: "https://api.misacard.com",
                    token: API_TOKEN
                };
            }
        }
        
        // åˆ‡æ¢ API é…ç½®
        function onApiChange() {
            const apiSelect = document.getElementById('apiSelect');
            const selectedIndex = parseInt(apiSelect.value);
            currentApiConfig = API_CONFIGS[selectedIndex];
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initApiConfigs();
            
            // ç›‘å¬ API é€‰æ‹©å˜åŒ–
            const apiSelect = document.getElementById('apiSelect');
            apiSelect.addEventListener('change', onApiChange);
        });

        // æŸ¥è¯¢å¡ç‰‡
        async function queryCard() {
            const input = document.getElementById('queryInput').value.trim();
            if (!input) {
                showError('è¯·è¾“å…¥å¡å¯†æˆ–å¡å·');
                return;
            }

            // åˆ¤æ–­è¾“å…¥ç±»å‹ï¼š16ä½çº¯æ•°å­—ä¸ºå¡å·ï¼Œå…¶ä»–æ ¼å¼ä¸ºå¡å¯†
            const isCardNumber = /^\d{16}$/.test(input);
            const isCardId = !isCardNumber;  // éå¡å·å³ä¸ºå¡å¯†

            // è¾“å…¥å·²åœ¨ä¸Šé¢éªŒè¯ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–éªŒè¯

            // éšè—æ‰€æœ‰å†…å®¹
            hideAllSections();
            document.getElementById('loadingState').classList.remove('hidden');

            try {
                if (isCardId) {
                    // æŸ¥è¯¢å¡å¯†
                    queryType = 'card_id';
                    currentCardId = input;
                    await queryByCardId(input);
                } else {
                    // æŸ¥è¯¢å¡å·
                    queryType = 'card_number';
                    currentCardNumber = input;
                    await queryByCardNumber(input);
                }
            } catch (error) {
                showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // æŸ¥è¯¢å¹¶æ¿€æ´»å¡ç‰‡
        async function queryAndActivateCard() {
            const input = document.getElementById('queryInput').value.trim();
            if (!input) {
                showError('è¯·è¾“å…¥å¡å¯†æˆ–å¡å·');
                return;
            }

            // åˆ¤æ–­è¾“å…¥ç±»å‹ï¼š16ä½çº¯æ•°å­—ä¸ºå¡å·ï¼Œå…¶ä»–æ ¼å¼ä¸ºå¡å¯†
            const isCardNumber = /^\d{16}$/.test(input);
            const isCardId = !isCardNumber;  // éå¡å·å³ä¸ºå¡å¯†

            // åªæœ‰å¡å¯†æ‰èƒ½æ¿€æ´»ï¼Œå¡å·åªèƒ½æŸ¥è¯¢
            if (isCardNumber) {
                showError('æŸ¥è¯¢å¹¶æ¿€æ´»åŠŸèƒ½ä»…æ”¯æŒå¡å¯†ï¼Œå¡å·è¯·ä½¿ç”¨æŸ¥è¯¢åŠŸèƒ½');
                return;
            }

            // éšè—æ‰€æœ‰å†…å®¹
            hideAllSections();
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('loadingState').querySelector('p').textContent = 'æ­£åœ¨æŸ¥è¯¢...';

            try {
                queryType = 'card_id';
                currentCardId = input;
                
                // ç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢å¡ç‰‡ï¼ˆä½¿ç”¨å½“å‰é€‰æ‹©çš„ API é…ç½®ï¼‰
                const apiUrl = `${currentApiConfig.base_url}/api/card/${encodeURIComponent(input)}`;
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentApiConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();

                // å¤„ç†æŸ¥è¯¢ç»“æœ
                if (result.error || !result.result) {
                    document.getElementById('loadingState').classList.add('hidden');
                    showError(result.error || result.msg || 'å¡ç‰‡ä¸å­˜åœ¨');
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }

                const cardData = result.result;
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¿€æ´»
                if (cardData.status === 'æœªæ¿€æ´»') {
                    // ç¬¬äºŒæ­¥ï¼šè°ƒç”¨æ¿€æ´»æ¥å£
                    document.getElementById('loadingState').querySelector('p').textContent = 'æ­£åœ¨æ¿€æ´»...';
                    
                    try {
                        const activateUrl = `${currentApiConfig.base_url}/api/card/activate/${encodeURIComponent(input)}`;
                        const activateResponse = await fetch(activateUrl, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${currentApiConfig.token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const activateResult = await activateResponse.json();

                        // æ£€æŸ¥é€Ÿç‡é™åˆ¶
                        const errorMsg = activateResult.error || activateResult.msg || '';
                        const isRateLimit = activateResponse.status === 429 || 
                            errorMsg.toLowerCase().includes('rate limit') || 
                            errorMsg.includes('é€Ÿç‡é™åˆ¶') || 
                            errorMsg.toLowerCase().includes('too many requests');
                        
                        if (isRateLimit) {
                            document.getElementById('loadingState').classList.add('hidden');
                            showError('æ¿€æ´»æ¥å£è§¦å‘é€Ÿç‡é™åˆ¶ï¼Œè¯·ç¨åå†è¯•');
                            document.getElementById('emptyState').classList.remove('hidden');
                            return;
                        }

                        // å¤„ç†æ¿€æ´»ç»“æœ
                        if (activateResult.error || !activateResult.result) {
                            document.getElementById('loadingState').classList.add('hidden');
                            showError(activateResult.error || activateResult.msg || 'æ¿€æ´»å¤±è´¥');
                            // å³ä½¿æ¿€æ´»å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºæŸ¥è¯¢åˆ°çš„ä¿¡æ¯
                            await displayQueryResult(cardData);
                            return;
                        }

                        // æ¿€æ´»æˆåŠŸï¼Œä½¿ç”¨æ¿€æ´»åçš„æ•°æ®
                        await displayQueryResult(activateResult.result);
                        showToast('å¡ç‰‡å·²æˆåŠŸæ¿€æ´»', 'success');
                    } catch (activateError) {
                        document.getElementById('loadingState').classList.add('hidden');
                        showError('æ¿€æ´»å¤±è´¥: ' + activateError.message);
                        // å³ä½¿æ¿€æ´»å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºæŸ¥è¯¢åˆ°çš„ä¿¡æ¯
                        await displayQueryResult(cardData);
                        return;
                    }
                } else {
                    // å·²æ¿€æ´»ï¼Œç›´æ¥æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
                    await displayQueryResult(cardData);
                }
            } catch (error) {
                document.getElementById('loadingState').classList.add('hidden');
                showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœï¼ˆç”¨äºæŸ¥è¯¢å¹¶æ¿€æ´»åŠŸèƒ½ï¼‰
        async function displayQueryResult(cardData) {
            // è½¬æ¢ API æ•°æ®æ ¼å¼
            const formattedData = {
                card_id: cardData.id,
                card_number: cardData.card_number ? String(cardData.card_number) : null,
                card_cvc: cardData.card_cvc || null,
                card_exp_date: cardData.card_exp_date || null,
                card_limit: cardData.card_limit || 0,
                billing_address: '131 Lupine Drive, Torrington, WY 82240',
                create_time: cardData.create_time || null,
                card_activation_time: cardData.card_activation_time || null,
                is_activated: !!cardData.card_activation_time,
                status: cardData.status,
                card_nickname: cardData.card_nickname || null,
                delete_date: cardData.delete_date || null
            };

            // å¦‚æœæœ‰å¡å·ï¼Œä¿å­˜å¡å·
            if (formattedData.card_number) {
                currentCardNumber = formattedData.card_number;
            }
            
            // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
            displayBasicInfo(formattedData);
            
            // éšè—åŠ è½½çŠ¶æ€
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        }

        // é€šè¿‡å¡å¯†æŸ¥è¯¢
        async function queryByCardId(cardId) {
            try {
                // ä½¿ç”¨å½“å‰é€‰æ‹©çš„ API é…ç½®
                const apiUrl = `${currentApiConfig.base_url}/api/card/${encodeURIComponent(cardId)}`;
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentApiConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();

                // å¤„ç† MisaCard API è¿”å›æ ¼å¼ {result, error, msg}
                if (result.error || !result.result) {
                    document.getElementById('loadingState').classList.add('hidden');
                    showError(result.error || result.msg || 'å¡ç‰‡ä¸å­˜åœ¨');
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }

                // è½¬æ¢ API æ•°æ®æ ¼å¼ï¼ˆæ ¹æ®çœŸå® API è¿”å›ç»“æ„ï¼‰
                const cardData = result.result;
                const formattedData = {
                    card_id: cardData.id,  // API è¿”å›çš„ id å­—æ®µ
                    card_number: cardData.card_number ? String(cardData.card_number) : null,  // è½¬ä¸ºå­—ç¬¦ä¸²
                    card_cvc: cardData.card_cvc || null,
                    card_exp_date: cardData.card_exp_date || null,
                    card_limit: cardData.card_limit || 0,
                    billing_address: '131 Lupine Drive, Torrington, WY 82240',  // å…¬å…±æŸ¥è¯¢å›ºå®šåœ°å€
                    create_time: cardData.create_time || null,
                    card_activation_time: cardData.card_activation_time || null,
                    is_activated: !!cardData.card_activation_time,  // æœ‰æ¿€æ´»æ—¶é—´å³ä¸ºå·²æ¿€æ´»
                    status: cardData.status,
                    card_nickname: cardData.card_nickname || null,  // å¡ç‰‡æ˜µç§°
                    delete_date: cardData.delete_date || null  // åˆ é™¤æ—¶é—´ï¼ˆåˆ°æœŸæ—¶é—´ï¼‰
                };

                // å¦‚æœæœ‰å¡å·ï¼Œä¿å­˜å¡å·ä½†ä¸è‡ªåŠ¨æŸ¥è¯¢äº¤æ˜“ä¿¡æ¯
                if (formattedData.card_number) {
                    currentCardNumber = formattedData.card_number;
                }
                
                // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                displayBasicInfo(formattedData);
                
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
            } catch (error) {
                document.getElementById('loadingState').classList.add('hidden');
                showError('æŸ¥è¯¢å¤±è´¥: ' + error.message);
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // é€šè¿‡å¡å·æŸ¥è¯¢
        async function queryByCardNumber(cardNumber) {
            currentCardNumber = cardNumber;
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            // æ˜¾ç¤ºäº¤æ˜“ä¿¡æ¯åŒºåŸŸ
            const transactionInfo = document.getElementById('transactionInfo');
            transactionInfo.classList.remove('hidden');
            
            // ç«‹å³æ»šåŠ¨åˆ°äº¤æ˜“ä¿¡æ¯åŒºåŸŸï¼ˆä¸ç­‰å¾…æŸ¥è¯¢å®Œæˆï¼‰
            setTimeout(() => {
                transactionInfo.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
            
            await loadTransactions();
        }

        // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        function displayBasicInfo(card) {
            // ä¿å­˜å¡ç‰‡æ•°æ®ç”¨äºå¤åˆ¶
            currentCardData = card;
            
            const container = document.getElementById('basicInfoContent');
            container.innerHTML = `
                <div class="flex items-start gap-2 border-b pb-2 lg:pb-3">
                    <div class="copy-field flex-1 p-1.5 lg:p-2 rounded ${!card.card_number ? 'opacity-50 cursor-not-allowed' : ''}" ${card.card_number ? `onclick="copyField('å¡å·', '${card.card_number}')"` : ''} title="${card.card_number ? 'ç‚¹å‡»å¤åˆ¶å¡å·' : 'æœªæ¿€æ´»'}">
                        <p class="text-xs lg:text-sm text-gray-500">å¡å·</p>
                        <p class="font-semibold text-gray-900 flex items-center gap-1.5 text-sm lg:text-base">
                            ${card.card_number || 'æœªæ¿€æ´»'}
                            ${card.card_number ? '<svg class="w-3.5 h-3.5 lg:w-4 lg:h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>' : ''}
                        </p>
                    </div>
                    ${card.card_number ? `
                    <button onclick="event.stopPropagation(); queryTransactionsAndScroll();" class="px-3 py-1.5 lg:px-4 lg:py-2 text-xs lg:text-sm font-semibold bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all flex items-center gap-1.5 flex-shrink-0 self-end mb-0.5 shadow-md hover:shadow-lg whitespace-nowrap" title="æŸ¥è¯¢ä½™é¢ä¸æ¶ˆè´¹è®°å½•">
                        <svg class="w-3.5 h-3.5 lg:w-4 lg:h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <span>æŸ¥è¯¢äº¤æ˜“è®°å½•</span>
                    </button>
                    ` : ''}
                </div>
                <div class="copy-field border-b pb-2 lg:pb-3 p-1.5 lg:p-2 rounded ${!card.card_cvc ? 'opacity-50 cursor-not-allowed' : ''}" ${card.card_cvc ? `onclick="copyField('CVC', '${card.card_cvc}')"` : ''} title="${card.card_cvc ? 'ç‚¹å‡»å¤åˆ¶CVC' : 'æœªæ¿€æ´»'}">
                    <p class="text-xs lg:text-sm text-gray-500">CVC</p>
                    <p class="font-semibold text-gray-900 flex items-center gap-1.5 text-sm lg:text-base">
                        ${card.card_cvc || 'æœªæ¿€æ´»'}
                        ${card.card_cvc ? '<svg class="w-3.5 h-3.5 lg:w-4 lg:h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>' : ''}
                    </p>
                </div>
                <div class="copy-field border-b pb-2 lg:pb-3 p-1.5 lg:p-2 rounded ${!card.card_exp_date ? 'opacity-50 cursor-not-allowed' : ''}" ${card.card_exp_date ? `onclick="copyField('æœ‰æ•ˆæœŸ', '${card.card_exp_date}')"` : ''} title="${card.card_exp_date ? 'ç‚¹å‡»å¤åˆ¶æœ‰æ•ˆæœŸ' : 'æœªæ¿€æ´»'}">
                    <p class="text-xs lg:text-sm text-gray-500">æœ‰æ•ˆæœŸ</p>
                    <p class="font-semibold text-gray-900 flex items-center gap-1.5 text-sm lg:text-base">
                        ${card.card_exp_date || 'æœªæ¿€æ´»'}
                        ${card.card_exp_date ? '<svg class="w-3.5 h-3.5 lg:w-4 lg:h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>' : ''}
                    </p>
                </div>
                <div class="border-b pb-2 lg:pb-3 p-1.5 lg:p-2">
                    <p class="text-xs lg:text-sm text-gray-500">é¢åº¦</p>
                    <p class="font-semibold text-gray-900 text-sm lg:text-base">$${card.card_limit}</p>
                </div>
                <div class="copy-field border-b pb-2 lg:pb-3 p-1.5 lg:p-2 rounded ${!card.billing_address ? 'opacity-50 cursor-not-allowed' : ''}" ${card.billing_address ? `onclick="copyField('è´¦å•åœ°å€', '${card.billing_address}')"` : ''} title="${card.billing_address ? 'ç‚¹å‡»å¤åˆ¶è´¦å•åœ°å€' : 'æ— åœ°å€'}">
                    <p class="text-xs lg:text-sm text-gray-500">è´¦å•åœ°å€</p>
                    <p class="font-semibold text-gray-900 flex items-center gap-1.5 text-xs lg:text-sm break-all">
                        ${card.billing_address || '-'}
                        ${card.billing_address ? '<svg class="w-3.5 h-3.5 lg:w-4 lg:h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>' : ''}
                    </p>
                </div>
                <div class="border-b pb-2 lg:pb-3 p-1.5 lg:p-2">
                    <p class="text-xs lg:text-sm text-gray-500">åˆ›å»ºæ—¶é—´</p>
                    <p class="font-semibold text-gray-900 text-xs lg:text-sm">${formatDate(card.create_time)}</p>
                </div>
                ${card.card_activation_time ? `
                <div class="border-b pb-2 lg:pb-3 p-1.5 lg:p-2">
                    <p class="text-xs lg:text-sm text-gray-500">æ¿€æ´»æ—¶é—´</p>
                    <p class="font-semibold text-gray-900 text-xs lg:text-sm">${formatDate(card.card_activation_time)}</p>
                </div>
                ` : ''}
                ${card.delete_date ? `
                <div class="border-b pb-2 lg:pb-3 p-1.5 lg:p-2">
                    <p class="text-xs lg:text-sm text-gray-500">åˆ°æœŸæ—¶é—´</p>
                    <p class="font-semibold text-gray-900 text-xs lg:text-sm">${formatDate(card.delete_date)}</p>
                </div>
                ` : ''}
            `;
            document.getElementById('cardBasicInfo').classList.remove('hidden');
        }

        // æŸ¥è¯¢äº¤æ˜“ä¿¡æ¯å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
        async function queryTransactionsAndScroll() {
            if (!currentCardNumber) {
                showError('æ²¡æœ‰å¯ç”¨çš„å¡å·');
                return;
            }
            
            // æ˜¾ç¤ºäº¤æ˜“ä¿¡æ¯åŒºåŸŸ
            const transactionInfo = document.getElementById('transactionInfo');
            transactionInfo.classList.remove('hidden');
            
            // ç«‹å³æ»šåŠ¨åˆ°äº¤æ˜“ä¿¡æ¯åŒºåŸŸï¼ˆä¸ç­‰å¾…æŸ¥è¯¢å®Œæˆï¼‰
            setTimeout(() => {
                transactionInfo.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
            
            // å¼€å§‹æŸ¥è¯¢äº¤æ˜“ä¿¡æ¯
            await loadTransactions();
        }

        // åŠ è½½äº¤æ˜“ä¿¡æ¯
        async function loadTransactions() {
            if (!currentCardNumber) return;

            // æ˜¾ç¤ºäº¤æ˜“ä¿¡æ¯åŒºåŸŸå’ŒåŠ è½½çŠ¶æ€
            const transactionInfo = document.getElementById('transactionInfo');
            const transactionLoading = document.getElementById('transactionLoading');
            const transactionContent = document.getElementById('transactionContent');
            
            transactionInfo.classList.remove('hidden');
            transactionLoading.classList.remove('hidden');
            transactionContent.classList.add('hidden');

            try {
                // ä½¿ç”¨å½“å‰é€‰æ‹©çš„ API é…ç½®
                const apiUrl = `${currentApiConfig.base_url}/api/m/get_card_info/${encodeURIComponent(currentCardNumber)}`;
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentApiConfig.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();

                // éšè—åŠ è½½çŠ¶æ€
                transactionLoading.classList.add('hidden');

                // å¤„ç† MisaCard API è¿”å›æ ¼å¼ {result, error, msg}
                if (result.error || !result.result) {
                    showError(result.error || result.msg || 'æ— æ³•è·å–äº¤æ˜“ä¿¡æ¯');
                    return;
                }

                // è½¬æ¢ API æ•°æ®æ ¼å¼ï¼ˆæ ¹æ®çœŸå® API è¿”å›ç»“æ„ï¼‰
                const cardInfo = result.result;
                const formattedData = {
                    available: cardInfo.available || 0,
                    posted: cardInfo.posted || 0,
                    pending: cardInfo.pending || 0,
                    unavailable: cardInfo.unavailable || 0,
                    transactions: (cardInfo.transactions || []).map(tx => ({
                        bank_description: tx.bank_description,
                        status: tx.status, 
                        created_at: tx.created_at,
                        kind: tx.kind,
                        amount: parseFloat(tx.amount) || 0,
                        reason_for_failure: tx.reason_for_failure  // API å­—æ®µå
                    }))
                };

                displayTransactions(formattedData);
                transactionContent.classList.remove('hidden');
            } catch (error) {
                transactionLoading.classList.add('hidden');
                showError('è·å–äº¤æ˜“ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºäº¤æ˜“ä¿¡æ¯
        function displayTransactions(txData) {
            // æ˜¾ç¤ºä½™é¢
            const balanceContainer = document.getElementById('balanceContent');
            balanceContainer.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded p-2.5 lg:p-3">
                    <p class="text-xs lg:text-sm text-blue-600">å¯ç”¨é¢åº¦</p>
                    <p class="text-lg lg:text-xl xl:text-2xl font-bold text-blue-900">$${txData.available || 0}</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded p-2.5 lg:p-3">
                    <p class="text-xs lg:text-sm text-green-600">å·²å…¥è´¦</p>
                    <p class="text-lg lg:text-xl xl:text-2xl font-bold text-green-900">$${txData.posted || 0}</p>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded p-2.5 lg:p-3">
                    <p class="text-xs lg:text-sm text-yellow-600">å¾…å¤„ç†</p>
                    <p class="text-lg lg:text-xl xl:text-2xl font-bold text-yellow-900">$${txData.pending || 0}</p>
                </div>
                <div class="bg-red-50 border border-red-200 rounded p-2.5 lg:p-3">
                    <p class="text-xs lg:text-sm text-red-600">ä¸å¯ç”¨</p>
                    <p class="text-lg lg:text-xl xl:text-2xl font-bold text-red-900">$${txData.unavailable || 0}</p>
                </div>
            `;

            // æ˜¾ç¤ºæ¶ˆè´¹è®°å½•
            const txContainer = document.getElementById('transactionsContent');
            if (txData.transactions && txData.transactions.length > 0) {
                txContainer.innerHTML = txData.transactions.map(tx => `
                    <div class="border border-gray-200 rounded p-2.5 lg:p-3 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-1.5 lg:gap-2 mb-0.5 lg:mb-1">
                                    <span class="font-semibold text-gray-900 text-xs lg:text-sm">${tx.bank_description || '-'}</span>
                                    <span class="px-1.5 py-0.5 lg:px-2 lg:py-1 text-xs lg:text-sm rounded ${tx.status === 'å¤±è´¥' ? 'bg-red-100 text-red-800' : tx.status === 'æˆåŠŸ' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        ${tx.status || '-'}
                                    </span>
                                </div>
                                <div class="flex items-center gap-2 text-xs lg:text-sm text-gray-600">
                                    <span>${tx.created_at || '-'}</span>
                                    <span class="text-gray-400">â€¢</span>
                                    <span>${tx.kind || '-'}</span>
                                </div>
                            </div>
                            <div class="text-right ml-3">
                                <div class="text-sm lg:text-base font-bold ${tx.amount < 0 ? 'text-red-600' : 'text-green-600'}">
                                    ${tx.amount > 0 ? '+' : ''}$${Math.abs(tx.amount || 0).toFixed(2)}
                                </div>
                            </div>
                        </div>
                        ${tx.reason_for_failure ? `
                        <div class="mt-1.5 lg:mt-2 pt-1.5 lg:pt-2 border-t border-gray-100">
                            <p class="text-xs lg:text-sm text-red-600">
                                <span class="font-semibold">å¤±è´¥åŸå› ï¼š</span>${tx.reason_for_failure}
                            </p>
                        </div>
                        ` : ''}
                    </div>
                `).join('');
            } else {
                txContainer.innerHTML = '<p class="text-gray-500 text-center py-3 lg:py-4 text-sm lg:text-base">æš‚æ— æ¶ˆè´¹è®°å½•</p>';
            }
        }

        // åˆ·æ–°äº¤æ˜“ä¿¡æ¯
        async function refreshTransactions() {
            if (!currentCardNumber) return;
            
            // ç¦ç”¨åˆ·æ–°æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            const refreshText = document.getElementById('refreshText');
            
            refreshBtn.disabled = true;
            refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
            refreshIcon.classList.add('animate-spin');
            refreshText.textContent = 'åˆ·æ–°ä¸­...';
            
            try {
                await loadTransactions();
                showToast('åˆ·æ–°æˆåŠŸ', 'success');
            } catch (error) {
                showToast('åˆ·æ–°å¤±è´¥', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                refreshIcon.classList.remove('animate-spin');
                refreshText.textContent = 'åˆ·æ–°';
            }
        }

        // å¤åˆ¶å•ä¸ªå­—æ®µ
        function copyField(fieldName, value) {
            if (!value || value === 'æœªæ¿€æ´»' || value === '-') {
                showToast(`${fieldName}æ— å¯å¤åˆ¶å†…å®¹`, 'error');
                return;
            }

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(value).then(() => {
                    showToast(`å·²å¤åˆ¶${fieldName}`, 'success');
                }).catch(() => {
                    fallbackCopy(value);
                    showToast(`å·²å¤åˆ¶${fieldName}`, 'success');
                });
            } else {
                fallbackCopy(value);
                showToast(`å·²å¤åˆ¶${fieldName}`, 'success');
            }
        }

        // ä¸€é”®å¤åˆ¶å¡ç‰‡ä¿¡æ¯
        function copyCardInfo() {
            if (!currentCardData) {
                showToast('æ²¡æœ‰å¯å¤åˆ¶çš„ä¿¡æ¯', 'error');
                return;
            }

            // æ„å»ºæ ¼å¼åŒ–çš„å¤åˆ¶æ–‡æœ¬ï¼ˆå¸¦æ ‡ç­¾çš„ä¸‰è¡Œæ ¼å¼ï¼‰
            const line1 = `å¡å·: ${currentCardData.card_number || 'æœªæ¿€æ´»'} æœ‰æ•ˆæœŸ: ${currentCardData.card_exp_date || 'æœªæ¿€æ´»'} CVC: ${currentCardData.card_cvc || 'æœªæ¿€æ´»'}`;
            const line2 = `é¢åº¦: $${currentCardData.card_limit} è´¦å•åœ°å€: ${currentCardData.billing_address || '-'}`;
            const line3 = currentCardData.delete_date ? `åˆ°æœŸæ—¶é—´: ${formatDate(currentCardData.delete_date)}` : '';
            
            const text = line3 ? `${line1}\n${line2}\n${line3}` : `${line1}\n${line2}`;

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('å·²å¤åˆ¶å…¨éƒ¨ä¿¡æ¯åˆ°å‰ªè´´æ¿', 'success');
                }).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            textarea.style.top = '0';
            textarea.style.left = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('Copy error:', err);
                showToast('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // éšè—æ‰€æœ‰åŒºå—
        function hideAllSections() {
            document.getElementById('cardBasicInfo').classList.add('hidden');
            document.getElementById('transactionInfo').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        // å½“å‰æ˜¾ç¤ºçš„toastå…ƒç´ å’Œå®šæ—¶å™¨
        let currentToast = null;
        let currentToastTimer = null;

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'info') {
            // å¦‚æœå·²æœ‰toastï¼Œç«‹å³ç§»é™¤
            if (currentToast) {
                clearTimeout(currentToastTimer);
                currentToast.remove();
                currentToast = null;
            }

            // åˆ›å»ºæ–°çš„toast
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2.5 lg:px-6 lg:py-3 rounded-lg shadow-lg text-white z-50 fade-in text-sm lg:text-base ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            currentToast = toast;

            // è®¾ç½®è‡ªåŠ¨æ¶ˆå¤±
            currentToastTimer = setTimeout(() => {
                if (currentToast === toast) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-20px)';
                    toast.style.transition = 'all 0.3s ease';
                    setTimeout(() => {
                        if (currentToast === toast) {
                            toast.remove();
                            currentToast = null;
                        }
                    }, 300);
                }
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // å›è½¦æŸ¥è¯¢
        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                queryCard();
            }
        });
    </script>
</body>
</html>

